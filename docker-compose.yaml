x-minio-common: &minio-common
  image: quay.io/minio/minio
  command: server --console-address :${MINIO_CONSOLE_PORT} http://minio{1...4}/data{1...2}
  expose:
    - ${MINIO_PORT_INTERNAL}
    - ${MINIO_CONSOLE_PORT_INTERNAL}
  environment:
    MINIO_ROOT_USER: ${MINIO_ROOT_USER}
    MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    MINIO_BROWSER_REDIRECT_URL: ${MINIO_BROWSER_REDIRECT_URL}
    MINIO_DOMAIN: ${MINIO_DOMAIN}
  networks:
    - app-network
  healthcheck:
    test: [ "CMD", "mc", "ready", "local" ]
    interval: 5s
    timeout: 5s
    retries: 5

x-backend-build: &backend-build
  context: ./src/backend
  dockerfile: Dockerfile

x-backend-common: &backend-common
  volumes:
    - ./src/backend/:/code
    - /code/.venv
  env_file:
    - ./.env
  networks:
    - app-network

# 1. Extracted common environment variables to a separate anchor for merging
x-kafka-env: &kafka-env
  # Cluster ID for KRaft mode
  CLUSTER_ID: abcdefghijklmnopqrstuv
  # KRaft settings (using dot notation)
  KAFKA_process.roles: controller,broker
  KAFKA_controller.quorum.voters: 0@kafka-0:9093,1@kafka-1:9093,2@kafka-2:9093
  # Listeners
  KAFKA_listeners: PLAINTEXT://:9092,CONTROLLER://:9093
  KAFKA_listener.security.protocol.map: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
  KAFKA_controller.listener.names: CONTROLLER
  KAFKA_inter.broker.listener.name: PLAINTEXT
  # Clustering
  KAFKA_offsets.topic.replication.factor: 3
  KAFKA_transaction.state.log.replication.factor: 3
  KAFKA_transaction.state.log.min.isr: 2
  # Log directories
  KAFKA_log.dirs: /var/lib/kafka/data

x-kafka-common: &kafka-common
  image: apache/kafka:4.1.1
  expose:
    - ${KAFKA_PORT_INTERNAL}
  # Removed 'environment' from here as it cannot be easily merged when overridden
  networks:
    - app-network

services:
  redis:
    image: redis:8.2.2-alpine
    expose:
      - ${REDIS_PORT_INTERNAL}
    volumes:
      - redis-data:/data
    command: redis-server --requirepass "${REDIS_PASSWORD}"
    networks:
      - app-network
    healthcheck:
      test: [ "CMD", "redis-cli", "--raw", "incr", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 3

  backend:
    <<: *backend-common
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    expose:
      - ${BACKEND_PORT_INTERNAL}
    build:
      <<: *backend-build
      target: backend
    environment:
      SERVICE_NAME: backend

  celery_worker:
    <<: *backend-common
    depends_on:
      - backend
      - redis
    container_name: celery_worker
    build:
      <<: *backend-build
      target: worker
    environment:
      SERVICE_NAME: celery

  flower:
    image: mher/flower:2.0.1
    container_name: flower
    env_file:
      - ./.env
    command: celery --broker=redis://:${REDIS_PASSWORD}@redis:${REDIS_PORT_INTERNAL}/0 flower --port=${FLOWER_PORT_INTERNAL} --url-prefix=/dev/flower
    expose:
      - ${FLOWER_PORT_INTERNAL}
    depends_on:
      - celery_worker
      - redis
    networks:
      - app-network

  postgres:
    image: postgis/postgis:18-3.6-alpine
    ports:
      - ${POSTGRES_PORT}:${POSTGRES_PORT_INTERNAL}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    networks:
      - app-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}" ]
      interval: 5s
      timeout: 5s
      retries: 5

  nginx:
    image: nginx:1.29.2-alpine-slim
    depends_on:
      - backend
      - flower
      - minio1
      - kafka-ui
    volumes:
      - ./src/nginx/conf/nginx.conf:/etc/nginx/nginx.conf.template
      - ./src/nginx/entrypoint.sh:/etc/nginx/entrypoint.sh
      - ./src/nginx/certs/:/etc/nginx/certs/
    environment:
      BACKEND_PORT_INTERNAL: ${BACKEND_PORT_INTERNAL}
      DOMAIN: ${DOMAIN}
      MAILHOG_UI_PORT_INTERNAL: ${MAILHOG_UI_PORT_INTERNAL}
      FLOWER_PORT_INTERNAL: ${FLOWER_PORT_INTERNAL}
      MINIO_PORT_INTERNAL: ${MINIO_PORT_INTERNAL}
      MINIO_CONSOLE_PORT_INTERNAL: ${MINIO_CONSOLE_PORT_INTERNAL}
      KAFKA_UI_PORT_INTERNAL: ${KAFKA_UI_PORT_INTERNAL}
    entrypoint: [ "/bin/sh", "/etc/nginx/entrypoint.sh" ]
    ports:
      - "${HTTP_PORT}:80"
      - "${HTTPS_PORT}:443"
    networks:
      - app-network

  mailhog:
    image: mailhog/mailhog:latest
    expose:
      - ${MAILHOG_UI_PORT_INTERNAL}
    ports:
      - ${MAILHOG_PORT}:${MAILHOG_PORT_INTERNAL}
    networks:
      - app-network

  backup:
    image: postgis/postgis:18-3.6
    container_name: backup
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT_INTERNAL: ${POSTGRES_PORT_INTERNAL}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      BACKUP_DIR: /backup
    volumes:
      - ./src/backup:/backup
    entrypoint: [ "sh", "-c", "chmod +x /backup/backup.sh 2>/dev/null || true; tail -f /dev/null" ]
    networks:
      - app-network

  minio1:
    <<: *minio-common
    hostname: minio1
    ports:
      - "${MINIO_PORT}:${MINIO_PORT_INTERNAL}"
      - "${MINIO_CONSOLE_PORT}:${MINIO_CONSOLE_PORT_INTERNAL}"
    volumes:
      - minio_1_1:/data1
      - minio_1_2:/data2

  minio2:
    <<: *minio-common
    hostname: minio2
    volumes:
      - minio_2_1:/data1
      - minio_2_2:/data2

  minio3:
    <<: *minio-common
    hostname: minio3
    volumes:
      - minio_3_1:/data1
      - minio_3_2:/data2

  minio4:
    <<: *minio-common
    hostname: minio4
    volumes:
      - minio_4_1:/data1
      - minio_4_2:/data2

  kafka-0:
    <<: *kafka-common
    hostname: kafka-0
    environment:
      # 2. Merge common env vars here
      <<: *kafka-env
      KAFKA_node.id: 0
      # 3. Use specific hostname for advertised listener
      KAFKA_advertised.listeners: PLAINTEXT://kafka-0:9092
    volumes:
      - kafka_0_data:/var/lib/kafka/data

  kafka-1:
    <<: *kafka-common
    hostname: kafka-1
    environment:
      <<: *kafka-env
      KAFKA_node.id: 1
      KAFKA_advertised.listeners: PLAINTEXT://kafka-1:9092
    volumes:
      - kafka_1_data:/var/lib/kafka/data

  kafka-2:
    <<: *kafka-common
    hostname: kafka-2
    environment:
      <<: *kafka-env
      KAFKA_node.id: 2
      KAFKA_advertised.listeners: PLAINTEXT://kafka-2:9092
    volumes:
      - kafka_2_data:/var/lib/kafka/data

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    depends_on:
      - kafka-0
      - kafka-1
      - kafka-2
    expose:
      - ${KAFKA_UI_PORT_INTERNAL}
    environment:
      KAFKA_CLUSTERS_0_NAME: picaspot-cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka-0:${KAFKA_PORT_INTERNAL},kafka-1:${KAFKA_PORT_INTERNAL},kafka-2:${KAFKA_PORT_INTERNAL}
      KAFKA_CLUSTERS_0_PROPERTIES_SECURITY_PROTOCOL: PLAINTEXT
      SERVER_SERVLET_CONTEXT_PATH: /dev/kafka
      SERVER_PORT: ${KAFKA_UI_PORT_INTERNAL}
    networks:
      - app-network

volumes:
  postgres_data:
  redis-data:
  minio_1_1:
  minio_1_2:
  minio_2_1:
  minio_2_2:
  minio_3_1:
  minio_3_2:
  minio_4_1:
  minio_4_2:
  kafka_0_data:
  kafka_1_data:
  kafka_2_data:

networks:
  app-network:
    driver: bridge
